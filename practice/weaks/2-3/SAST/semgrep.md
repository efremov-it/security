–û—Ç–ª–∏—á–Ω–æ, Alexander. –ù–∏–∂–µ ‚Äî **—É–ª—É—á—à–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Semgrep-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –¥–ª—è GitLab CI**, –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Semgrep Cloud. –í—Å—ë –∑–∞—Ç–æ—á–µ–Ω–æ –ø–æ–¥ **–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**, **–≥–∏–±–∫–æ—Å—Ç—å**, **–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** –∏ **–ª–µ–≥–∫–æ—Å—Ç—å —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è**.

---

## ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–ª–∞–Ω CI-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Semgrep (–±–µ–∑ Cloud)**

### üîπ 1. –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç `semgrep-diff`

–≠—Ç–æ —è–¥—Ä–æ –≤—Å–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

#### –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:

```text
semgrep-diff/
‚îú‚îÄ‚îÄ .gitlab-ci.yml               # CI —à–∞–±–ª–æ–Ω –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
‚îú‚îÄ‚îÄ scan.sh                      # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞
‚îú‚îÄ‚îÄ rules/
‚îÇ   ‚îú‚îÄ‚îÄ common/                  # –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞
‚îÇ   ‚îú‚îÄ‚îÄ dockerfile/
‚îÇ   ‚îú‚îÄ‚îÄ go/
‚îÇ   ‚îú‚îÄ‚îÄ php/
‚îÇ   ‚îú‚îÄ‚îÄ python/
‚îÇ   ‚îú‚îÄ‚îÄ nodejs/
‚îÇ   ‚îî‚îÄ‚îÄ ruby/
‚îú‚îÄ‚îÄ custom/
‚îÇ   ‚îî‚îÄ‚îÄ business-logic/          # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–¥ –ø—Ä–æ–¥—É–∫—Ç
‚îî‚îÄ‚îÄ README.md
```

---

### üîπ 2. –°–∫—Ä–∏–ø—Ç `scan.sh`

```bash
#!/bin/bash
set -euo pipefail

LANGUAGE="${1:-}"
BASELINE="${2:-origin/main}"
RULES_DIR="./rules"

if [[ -z "$LANGUAGE" ]]; then
  echo "Usage: scan.sh <language>"
  exit 1
fi

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞
CONFIGS=()
CONFIGS+=("--config=${RULES_DIR}/common")
[[ -d "${RULES_DIR}/${LANGUAGE}" ]] && CONFIGS+=("--config=${RULES_DIR}/${LANGUAGE}")

# –ó–∞–ø—É—Å–∫
semgrep ci \
  "${CONFIGS[@]}" \
  --baseline-ref "$BASELINE" \
  --json > semgrep-report.json
```

---

### üîπ 3. GitLab CI —à–∞–±–ª–æ–Ω `.gitlab-ci.yml` (–≤ `semgrep-diff`)

```yaml
semgrep_scan:
  image: returntocorp/semgrep:latest
  stage: test
  variables:
    GIT_DEPTH: 0
  script:
    - ./scan.sh "$PROJECT_LANG"
  artifacts:
    paths:
      - semgrep-report.json
    expire_in: 1 day
  allow_failure: true
```

---

### üîπ 4. –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö

#### –í `.gitlab-ci.yml` —Ü–µ–ª–µ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:

```yaml
include:
  - project: devsec/semgrep-diff
    file: '/.gitlab-ci.yml'
    ref: main

variables:
  PROJECT_LANG: "go"  # –ò–ª–∏ php, nodejs –∏ —Ç.–¥.
```

---

### üîπ 5. –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è

#### üìÅ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª:

```bash
semgrep ci \
  --config rules/go \
  --config custom/business-logic/api-tokens.yaml \
  ...
```

#### üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª (lint):

```yaml
semgrep_lint:
  image: returntocorp/semgrep:latest
  script:
    - semgrep --validate rules/
```

---

## üìå **Best practices GitLab-only –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Semgrep**

| –ü–æ–¥—Ö–æ–¥                     | –ü—Ä–∞–∫—Ç–∏–∫–∞                                                     |
| -------------------------- | ------------------------------------------------------------ |
| –•—Ä–∞–Ω–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞    | –í `custom/` –∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä—É–π —á–µ—Ä–µ–∑ MR-review                    |
| –ù–∞—Å—Ç—Ä–æ–π baseline –∞–Ω–∞–ª–∏–∑    | `--baseline-ref origin/main` –¥–ª—è pull request –∞–Ω–∞–ª–∏–∑–æ–≤       |
| –ê–≤—Ç–æ—Ç–µ—Å—Ç—ã –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª | –ò—Å–ø–æ–ª—å–∑—É–π `semgrep test` (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π `test.sh`) |
| –û–±—â–∏–µ —à–∞–±–ª–æ–Ω—ã              | –í—ã–Ω–æ—Å–∏ `.gitlab-ci.yml` –∏ —Å–∫—Ä–∏–ø—Ç—ã –≤ shared CI –ø—Ä–æ–µ–∫—Ç         |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ   | –ù–µ –ø–æ–¥–≥—Ä—É–∂–∞–π –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ `--config` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏     |
| –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫           | –ü–æ–¥–¥–µ—Ä–∂–∏ `make scan LANG=go` –∏–ª–∏ `docker run -v ...`         |
| –•—Ä–∞–Ω–∏ –æ—Ç—á—ë—Ç—ã               | –í GitLab artifacts, –Ω–æ –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ (1 –¥–µ–Ω—å)             |

---

## üß† –ü—Ä–∏–º–µ—Ä –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ (Dockerfile)

```yaml
rules:
  - id: no-sudo-docker
    languages: [dockerfile]
    pattern: RUN sudo ...
    message: "Avoid using sudo in Dockerfile ‚Äî not needed for non-root base images."
    severity: WARNING
    metadata:
      category: security
```

---

## üìà –ö–∞–∫ –¥–µ–ª–∞—é—Ç –±–æ–ª—å—à–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ (GitLab-only)

* **Google/Facebook:** –∏—Å–ø–æ–ª—å–∑—É—é—Ç Semgrep –≤ –≤–∏–¥–µ self-hosted (–ª–∏–±–æ CI-only), –ø–æ–ª–Ω–æ—Å—Ç—å—é –±–µ–∑ Cloud.
* **GitLab:** —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –æ—Ç–¥–µ–ª—å–Ω–æ –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `.gitlab-ci.yml` –º–µ–∂–¥—É –ø—Ä–æ–µ–∫—Ç–∞–º–∏.
* **Datadog/Shopify:** –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä—É—é—Ç –ø—Ä–∞–≤–∏–ª–∞ –ø–æ —è–∑—ã–∫–∞–º –∏ –±–∏–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç—É, CI –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ diff.
* **Slack:** –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–∞–∂–¥–æ–µ –ø—Ä–∞–≤–∏–ª–æ —á–µ—Ä–µ–∑ `semgrep test`.

---

## ‚úÖ –ß—Ç–æ –µ—â—ë –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å?

* [ ] **Makefile**: `make scan LANG=go`
* [ ] **pre-commit hook**: –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
* [ ] **–æ—Ç–¥–µ–ª—å–Ω—ã–π job –¥–ª—è `semgrep test`** –≤ `MR`
* [ ] **–æ—Ç—á—ë—Ç –≤ markdown** ‚Äî –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ `semgrep-report.json` –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥ (—á–µ—Ä–µ–∑ jq/python)

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —è –º–æ–≥—É –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —à–∞–±–ª–æ–Ω `semgrep-diff` GitLab-–ø—Ä–æ–µ–∫—Ç–∞ —Å –ø–æ–ª–Ω—ã–º CI –∏ –ø–∞—Ä–æ–π –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª. –°–∫–∞–∂–∏ —Ç–æ–ª—å–∫–æ, –Ω–∞ –∫–∞–∫–æ–º —è–∑—ã–∫–µ —Ö–æ—á–µ—à—å –ø—Ä–∏–º–µ—Ä (Go, Node, Ruby –∏ —Ç.–¥.) –∏ –Ω—É–∂–Ω–æ –ª–∏ `Makefile`/pre-commit.
